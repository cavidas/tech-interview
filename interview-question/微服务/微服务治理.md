限流、降级、容错，以及服务的弹性伸缩、灰度发布等等，线下的治理基本上不涉及
https://www.infoq.cn/article/q65dDiRTdSbF*E6Ki2P4

https://static001.infoq.cn/resource/image/b4/ac/b43b4203de4c4e748942fbf1fbc32eac.png

服务注册发现：Eurake，Dobbo，Consul，ZooKeeper
服务配置：Spring Cloud Config，Archaius
服务熔断：Hystrix，resilience4j
网关：Zuul，Spring Cloud Gateway
负载均衡：Ribbon，Feign
追踪工具：Sleuth，Zipkin，Htrace
日志采集：logback，ElasticSearch
监控平台：Promethues，Kibana，grafna，Spring boot admin

Very good: 链接：https://www.jianshu.com/p/dd818114ab4b
    * idea: 第一要采集信息，然后要能够对采集的信息进行监控和分析，最后根据分析的结果采取对应的治理策略。另外从整体安全的角度考虑还需要一个守门人。
    * 网关就是整个整体的守门人，日志采集，追踪工具，服务注册发现都是用来采集信息的，
    然后需要监控平台来展现这些采集的信息，并进行监控和分析。
    最后根据分析的结果采取治理策略，有的服务快撑不住了要限流，有的服务坏了要熔断，并且还能够及时的调整这些服务的配置。

# 负载均衡
## Source
https://juejin.im/post/6844903793012768781

## [负载均衡算法](https://juejin.im/post/6844903793012768781)
1. 轮询法
将请求按顺序轮流地分配到后端服务器上，它均衡地对待后端的每一台服务器，而不关心服务器实际的连接数和当前的系统负载。
2. 随机法
通过系统的随机算法，根据后端服务器的列表大小值来随机选取其中的一台服务器进行访问。由概率统计理论可以得知，随着客户端调用服务端的次数增多，
其实际效果越来越接近于平均分配调用量到后端的每一台服务器，也就是轮询的结果。
3. 源地址哈希法
源地址哈希的思想是根据获取客户端的IP地址，通过哈希函数计算得到的一个数值，用该数值对服务器列表的大小进行取模运算，得到的结果便是客服端要访问服务器的序号。
采用源地址哈希法进行负载均衡，同一IP地址的客户端，当后端服务器列表不变时，它每次都会映射到同一台后端服务器进行访问。
巧妙的解决了负载均衡下Session共享的问题，用户小明走的永远是A服务器，用户小笨永远走的是B服务器。
    * 哈希环。 每个服务器控制一个圆上一部门的hash过的请求，为了防止因为一个服务器坏掉之后其他服务器控制太多区域（“哈希倾斜”）
    用虚拟节点，一个服务器在环上有多个虚拟节点，如果hash是虚拟节点处理，实际上也是对应的服务器处理

4. 加权轮询法
不同的后端服务器可能机器的配置和当前系统的负载并不相同，因此它们的抗压能力也不相同。给配置高、负载低的机器配置更高的权重，让其处理更多的请；而配置低、负载高的机器，给其分配较低的权重，降低其系统负载，加权轮询能很好地处理这一问题，并将请求顺序且按照权重分配到后端。
5. 加权随机法
与加权轮询法一样，加权随机法也根据后端机器的配置，系统的负载分配不同的权重。不同的是，它是按照权重随机请求后端服务器，而非顺序。
6. 最小连接数法
最小连接数算法比较灵活和智能，由于后端服务器的配置不尽相同，对于请求的处理有快有慢，它是根据后端服务器当前的连接情况，动态地选取其中当前 积压连接数最少的一台服务器来处理当前的请求，尽可能地提高后端服务的利用效率，将负责合理地分流到每一台服务器。
7. 平滑加权轮询
加权轮询可能会出现其中一台服务器的压力可能会突然上升，而另外的服务器却很“悠闲。
比如A服务器的权重是5，B服务器的权重是1，C服务器的权重是1。 这个权重，我们称之为“固定权重”，既然这个叫“固定权重”，那么肯定还有叫“非固定权重的”，没错，“非固定权重”每次都会根据一定的规则变动。
第一次访问，ABC的“非固定权重”分别是 5 1 1（初始），因为5是其中最大的，5对应的就是A服务器，所以这次选到的服务器就是A，然后我们用当前被选中的服务器的权重-各个服务器的权重之和，也就是A服务器的权重-各个服务器的权重之和。也就是5-7=-2，没被选中的服务器的“非固定权重”不做变化，现在三台服务器的“非固定权重”分别是-2 1 1。
第二次访问，把第一次访问最后得到的“非固定权重”+“固定权重”，现在三台服务器的“非固定权重”是3，2，2，因为3是其中最大的，3对应的就是A服务器，所以这次选到的服务器就是A，然后我们用当前被选中的服务器的权重-各个服务器的权重之和，也就是A服务器的权重-各个服务器的权重之和。也就是3-7=-4，没被选中的服务器的“非固定权重”不做变化，现在三台服务器的“非固定权重”分别是-4 1 1。
第三次访问，把第二次访问最后得到的“非固定权重”+“固定权重”，现在三台服务器的“非固定权重”是1，3，3，这个时候3虽然是最大的，但是却出现了两个，我们选第一个，第一个3对应的就是B服务器，所以这次选到的服务器就是B，然后我们用当前被选中的服务器的权重-各个服务器的权重之和，也就是B服务器的权重-各个服务器的权重之和。也就是3-7=-4，没被选中的服务器的“非固定权重”不做变化，现在三台服务器的“非固定权重”分别是1 -4 3。
...
以此类推，最终得到这样的表格：

## 从负载均衡设备的角度来看，分为硬件负载均衡和软件负载均衡：   
硬件负载均衡：比如最常见的F5，还有Array等，这些负载均衡是商业的负载均衡器，性能比较好，毕竟他们的就是为了负载均衡而生的，背后也有非常成熟的团队，可以提供各种解决方案，但是价格比较昂贵，所以没有充足的理由，充足的软妹币是不会考虑的。
软件负载均衡：包括我们耳熟能详的Nginx，LVS，Tengine（阿里对Nginx进行的改造）等。优点就是成本比较低，但是也需要有比较专业的团队去维护，要自己去踩坑，去DIY。

## 负载均衡的技术来看，分为服务端负载均衡和客户端负载均衡：
* 服务端负载均衡：当我们访问一个服务，请求会先到另外一台服务器，然后这台服务器会把请求分发到提供这个服务的服务器，
当然如果只有一台服务器，那好说，直接把请求给那一台服务器就可以了，但是如果有多台服务器呢？这时候，就会根据一定的算法选择一台服务器。
* 客户端负载均衡：客户端服务均衡的概念貌似是有了服务治理才产生的，简单的来说，就是在一台服务器上维护着所有服务的ip，名称等信息，
当我们在代码中访问一个服务，是通过一个组件访问的，这个组件会从那台服务器上取到所有提供这个服务的服务器的信息，然后通过一定的算法，选择一台服务器进行请求。

## [六大Web负载均衡原理与实现](https://www.cnblogs.com/aspirant/p/9087716.html)
https://cloud.tencent.com/developer/article/1082193
1. http重定向
    性能不佳，而且，给用户的体验也不好，实际请求发生重定向，增加了网络延时
2. DNS负载均衡
    配置简单，性能极佳
    不能自由定义规则，而且，变更被映射的IP或者机器故障时很麻烦，还存在DNS生效延迟的问题
3. 反向代理负载均衡 (NGINX)
    实现和部署非常简单，性能也很好，可以方便的自定义转发规则
    有“单点故障”的问题，如果挂了，会带来很多的麻烦，而且，随着Web服务器继续增加，它本身可能成为系统的瓶颈
4. IP负载均衡-NAT(LVS-NAT Linux Virtual Server-Network Address Translation) 更改ip地址  
    性能比反向代理负载均衡高很多，非常稳定
    功能单一，配置复杂
5. 直接路由(IP负载均衡-DR)(LVS-DR Linux Virtual Server Direct Routing) 修改MAC地址
    NAT是工作在网络分层模型的传输层（第四层），而直接路由是工作在数据链路层（第二层）
6. IP隧道 (IP负载均衡-Tunneling)(LVS-TUN Linux Virtaul Server Tunneling) 将调度器收到的IP数据包封装在一个新的IP数据包中，转交给实际服务器，然后实际服务器的响应数据包可以直接到达用户端。
    可以将实际服务器根据需要部署在不同的地域，并且根据就近访问的原则来转移请求

# 熔断降级
## 降级方式
延迟服务：比如发表了评论，重要服务，比如在文章中显示正常，但是延迟给用户增加积分，只是放到一个缓存中，等服务平稳之后再执行。
在粒度范围内关闭服务（片段降级或服务功能降级）：比如关闭相关文章的推荐，直接关闭推荐区
页面异步请求降级：比如商品详情页上有推荐信息/配送至等异步加载的请求，如果这些信息响应慢或者后端服务有问题，可以进行降级；
页面跳转（页面降级）：比如可以有相关文章推荐，但是更多的页面则直接跳转到某一个地址
写降级：比如秒杀抢购，我们可以只进行Cache的更新，然后异步同步扣减库存到DB，保证最终一致性即可，此时可以将DB降级为Cache。
读降级：比如多级缓存模式，如果后端服务有问题，可以降级为只读缓存，这种方式适用于对读一致性要求不高的场景。
## 降级预案
在进行降级之前要对系统进行梳理，看看系统是不是可以丢卒保帅；从而梳理出哪些必须誓死保护，哪些可降级；比如可以参考日志级别设置预案：
链接：https://www.jianshu.com/p/cda7c0366089
https://www.cnblogs.com/rjzheng/p/10340176.html

##hystrix 实现
https://developer.aliyun.com/article/269141
1. 设计微服务框架考虑了什么？

